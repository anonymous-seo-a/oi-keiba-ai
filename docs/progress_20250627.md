# 🏇 大井競馬予想AI - プロジェクト進捗レポート

## 📅 2025年6月27日 作業報告

### ✅ 完了事項

1. **環境構築**
   - Python 3.13環境の構築完了
   - 仮想環境（venv）のセットアップ
   - 全依存関係のインストール成功

2. **テスト環境**
   - 全6テストが正常にパス
   - テストカバレッジ確認済み

3. **Webアプリケーション**
   - Streamlitアプリが正常に起動
   - 基本的なUIが動作確認済み

4. **サンプルデータ**
   - サンプルデータ作成スクリプトの実装
   - テスト用データベースの構築

### 🔧 現在の課題

1. **データ収集の問題**
   - netkeibaからのスクレイピングが0件（URL形式またはコースコードの問題）
   - コマンドライン引数が機能しない（常に3年前から開始）

2. **モデル予測エラー**
   - 特徴量の数の不一致（訓練時：13個、予測時：11個）
   - データ型の不一致（jockey_nameが訓練時int64、予測時object）
   - 予測時の特徴量作成ロジックに問題

### 📊 技術的詳細

#### エラー1: 特徴量作成時のエラー
```
騎手・調教師特徴量作成エラー: You are trying to merge on int64 and object columns for key 'jockey_name'
```

#### エラー2: LightGBMエラー
```
[LightGBM] [Fatal] The number of features in data (11) is not the same as it was in training data (13).
```

### 🚀 次回の作業計画

1. **スクレイピング修正**
   - netkeibaのURL形式の調査
   - コースコードの確認と修正
   - レース情報取得ロジックの改善

2. **モデル修正**
   - 特徴量作成ロジックの完全な見直し
   - 訓練時と予測時の特徴量の一致を保証
   - データ型の統一化

3. **デバッグ強化**
   - より詳細なログ出力の追加
   - 中間データの検証ツール作成
   - エラーハンドリングの改善

### 💡 学習事項

1. **LightGBMの特徴量管理**
   - 訓練時と予測時で同じ特徴量が必要
   - LabelEncoderの状態保持が重要
   - カテゴリカル変数の処理順序に注意

2. **pandas操作**
   - mergeする際のデータ型の一致が必須
   - fillnaのタイミングが重要
   - groupbyとmergeの組み合わせに注意

### 📈 プロジェクト全体の進捗

- **Phase 1**: 基盤構築 ✅ 完了
- **Phase 2**: データ分析・特徴量エンジニアリング 🔄 60%（デバッグ中）
- **Phase 3**: モデル開発・最適化 🔄 40%（基本実装済み、修正必要）
- **Phase 4**: 実運用・改善 📋 未着手

### 🔗 関連ファイル

- `/src/models/lightgbm_model.py` - 2回の修正を実施
- `/scripts/daily_prediction.py` - 予測実行スクリプト
- `/scripts/train_model.py` - モデル訓練スクリプト